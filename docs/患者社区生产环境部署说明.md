# 患者社区生产环境部署说明

## 🌐 永久访问地址

**网站地址**: https://80-i9vsk9cwbog8xzwzo460r-0ecdc938.sg1.manus.computer

**测试账号**:
- 用户名: `testuser`
- 密码: `123456`

## 📦 部署架构

### 生产环境架构
```
                    ┌─────────────────┐
                    │   公网访问      │
                    │   (Port 80)     │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │     Nginx       │
                    │  反向代理服务器  │
                    └────────┬────────┘
                             │
                ┌────────────┴────────────┐
                │                         │
       ┌────────▼────────┐      ┌────────▼────────┐
       │  静态文件服务    │      │   FastAPI后端   │
       │  (Vue 3 构建)   │      │   (Port 8000)   │
       │  /frontend/dist │      │   Uvicorn服务   │
       └─────────────────┘      └─────────────────┘
                                         │
                                ┌────────▼────────┐
                                │  SQLite数据库   │
                                │  patient_       │
                                │  community.db   │
                                └─────────────────┘
```

### 技术栈
- **Web服务器**: Nginx 1.18.0
- **前端**: Vue 3 生产构建版本
- **后端**: FastAPI + Uvicorn
- **数据库**: SQLite
- **反向代理**: Nginx

## 🚀 部署步骤

### 1. 前端构建
```bash
cd /home/ubuntu/patient-community/frontend
pnpm build
```

构建产物位于: `/home/ubuntu/patient-community/frontend/dist/`

### 2. Nginx配置
配置文件位置: `/etc/nginx/sites-available/patient-community`

主要配置:
- 静态文件服务: `/` -> `/home/ubuntu/patient-community/frontend/dist`
- API代理: `/api` -> `http://127.0.0.1:8000`
- 文件上传: `/uploads` -> `http://127.0.0.1:8000`
- API文档: `/docs` -> `http://127.0.0.1:8000`

### 3. 后端服务
启动命令:
```bash
cd /home/ubuntu/patient-community/backend
nohup uvicorn app.main:app --host 127.0.0.1 --port 8000 > /dev/null 2>&1 &
```

### 4. 服务管理

#### 启动所有服务
```bash
# 启动Nginx
sudo nginx

# 启动后端
cd /home/ubuntu/patient-community/backend
nohup uvicorn app.main:app --host 127.0.0.1 --port 8000 > /dev/null 2>&1 &
```

#### 停止服务
```bash
# 停止Nginx
sudo nginx -s stop

# 停止后端
pkill -f "uvicorn app.main:app"
```

#### 重启服务
```bash
# 重启Nginx
sudo nginx -s reload

# 重启后端
pkill -f "uvicorn app.main:app"
cd /home/ubuntu/patient-community/backend
nohup uvicorn app.main:app --host 127.0.0.1 --port 8000 > /dev/null 2>&1 &
```

#### 查看服务状态
```bash
# 查看进程
ps aux | grep -E "(nginx|uvicorn)" | grep -v grep

# 测试Nginx
curl http://localhost/

# 测试后端API
curl http://localhost/health
```

## 📁 文件结构

### 生产环境文件
```
/home/ubuntu/patient-community/
├── frontend/
│   └── dist/                    # 前端构建产物（生产版本）
│       ├── index.html
│       └── assets/              # JS和CSS文件
│
├── backend/
│   ├── app/                     # 后端应用代码
│   ├── patient_community.db     # SQLite数据库
│   └── uploads/                 # 用户上传文件
│
├── nginx.conf                   # Nginx配置文件
└── 患者社区生产环境部署说明.md  # 本文件
```

### Nginx配置文件
- 源文件: `/home/ubuntu/patient-community/nginx.conf`
- 实际配置: `/etc/nginx/sites-available/patient-community`
- 软链接: `/etc/nginx/sites-enabled/patient-community`

## 🔧 配置说明

### Nginx配置要点

1. **静态文件服务**
   - 根目录指向前端构建产物
   - 启用缓存（1小时）
   - 支持SPA路由（try_files）

2. **API反向代理**
   - 所有 `/api` 请求转发到后端
   - 保留原始请求头信息
   - 支持WebSocket（如需要）

3. **文件权限**
   - 确保Nginx有权限访问静态文件
   - 目录权限: 755
   - 文件权限: 644

### 后端配置要点

1. **监听地址**
   - 仅监听 127.0.0.1（本地）
   - 通过Nginx对外提供服务
   - 提高安全性

2. **数据库**
   - 使用SQLite
   - 数据库文件: `patient_community.db`
   - 自动创建表结构

3. **文件上传**
   - 上传目录: `backend/uploads/`
   - 最大文件大小: 10MB
   - 支持格式: JPG, PNG, PDF, DOC, DOCX

## 🔐 安全措施

### 已实施的安全措施

1. **后端安全**
   - JWT Token认证
   - 密码bcrypt加密
   - 仅监听本地地址
   - SQL注入防护（ORM）

2. **前端安全**
   - XSS防护（Vue自动转义）
   - CORS配置
   - 安全的HTTP头

3. **文件安全**
   - 文件类型验证
   - 文件大小限制
   - 上传文件隔离存储

### 建议的额外安全措施

1. **HTTPS配置**
   - 使用Let's Encrypt免费证书
   - 强制HTTPS重定向
   - 配置HSTS

2. **防火墙规则**
   - 仅开放80/443端口
   - 限制SSH访问
   - 配置fail2ban

3. **访问控制**
   - API速率限制
   - IP黑白名单
   - 防止暴力破解

## 📊 性能优化

### 已实施的优化

1. **前端优化**
   - 生产构建（压缩、混淆）
   - 静态资源缓存
   - Gzip压缩
   - 代码分割

2. **后端优化**
   - 数据库索引
   - 连接池
   - 异步处理

3. **Nginx优化**
   - 多worker进程
   - 静态文件缓存
   - Gzip压缩

### 建议的进一步优化

1. **CDN加速**
   - 静态资源使用CDN
   - 图片CDN
   - 全球加速

2. **缓存策略**
   - Redis缓存
   - 数据库查询缓存
   - API响应缓存

3. **数据库优化**
   - 切换到MySQL
   - 读写分离
   - 主从复制

## 🔍 监控和日志

### 日志位置

1. **Nginx日志**
   - 访问日志: `/var/log/nginx/access.log`
   - 错误日志: `/var/log/nginx/error.log`

2. **后端日志**
   - 标准输出重定向到 `/dev/null`
   - 可修改为输出到文件

### 监控命令

```bash
# 查看Nginx访问日志
sudo tail -f /var/log/nginx/access.log

# 查看Nginx错误日志
sudo tail -f /var/log/nginx/error.log

# 查看后端进程
ps aux | grep uvicorn

# 查看端口监听
netstat -tlnp | grep -E "(80|8000)"

# 查看系统资源
top
```

## 🐛 故障排查

### 常见问题

1. **网站无法访问**
   - 检查Nginx是否运行: `ps aux | grep nginx`
   - 检查端口是否监听: `netstat -tlnp | grep 80`
   - 查看Nginx错误日志

2. **API请求失败**
   - 检查后端是否运行: `ps aux | grep uvicorn`
   - 测试后端健康检查: `curl http://127.0.0.1:8000/health`
   - 检查数据库文件是否存在

3. **静态文件404**
   - 检查文件权限: `ls -la /home/ubuntu/patient-community/frontend/dist/`
   - 确认构建是否成功
   - 查看Nginx配置

4. **上传文件失败**
   - 检查uploads目录权限
   - 确认文件大小限制
   - 查看后端日志

### 重启所有服务

```bash
# 完全重启
sudo nginx -s stop
pkill -f "uvicorn app.main:app"
sleep 2
sudo nginx
cd /home/ubuntu/patient-community/backend
nohup uvicorn app.main:app --host 127.0.0.1 --port 8000 > /dev/null 2>&1 &
```

## 📈 扩展建议

### 水平扩展

1. **多后端实例**
   - 使用Nginx负载均衡
   - 配置多个Uvicorn进程
   - Session共享（Redis）

2. **数据库扩展**
   - 切换到MySQL
   - 配置主从复制
   - 读写分离

3. **静态资源分离**
   - 使用对象存储（S3/OSS）
   - CDN加速
   - 图片服务器

### 功能扩展

1. **实时功能**
   - WebSocket支持
   - 实时聊天
   - 推送通知

2. **高级功能**
   - 全文搜索（Elasticsearch）
   - 数据分析
   - 机器学习推荐

## 📝 维护清单

### 日常维护

- [ ] 每天检查服务运行状态
- [ ] 每周备份数据库
- [ ] 每月清理日志文件
- [ ] 定期更新依赖包

### 定期任务

- [ ] 数据库备份
- [ ] 日志轮转
- [ ] 磁盘空间检查
- [ ] 性能监控

### 紧急响应

- [ ] 服务宕机处理流程
- [ ] 数据恢复流程
- [ ] 安全事件响应
- [ ] 联系方式备案

## 🎯 生产环境检查清单

### 部署前检查

- [x] 前端构建成功
- [x] 后端服务正常
- [x] 数据库初始化
- [x] Nginx配置正确
- [x] 文件权限设置
- [x] 测试账号可用

### 部署后验证

- [x] 网站可访问
- [x] API接口正常
- [x] 用户登录功能
- [x] 文件上传功能
- [x] 数据库读写
- [x] 静态资源加载

### 性能测试

- [ ] 页面加载速度
- [ ] API响应时间
- [ ] 并发用户测试
- [ ] 压力测试

## 📞 技术支持

### 文档资源
- 项目README: `/home/ubuntu/patient-community/README.md`
- 系统设计: `/home/ubuntu/system_design.md`
- 项目清单: `/home/ubuntu/patient-community/PROJECT_SUMMARY.md`

### 在线资源
- API文档: https://80-i9vsk9cwbog8xzwzo460r-0ecdc938.sg1.manus.computer/docs
- 网站地址: https://80-i9vsk9cwbog8xzwzo460r-0ecdc938.sg1.manus.computer

---

**部署日期**: 2026年2月2日  
**部署状态**: ✅ 生产环境运行中  
**服务类型**: Nginx + FastAPI + SQLite  
**访问方式**: HTTPS公网访问
